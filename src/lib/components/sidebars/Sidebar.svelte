<script lang="ts">
	import { invoke } from "@tauri-apps/api/core";
	import { Home, Plus, Settings } from "@lucide/svelte";
	import { goto } from "$app/navigation";
	import { page } from "$app/stores";
	import { userStore } from "$lib/stores/userStore";
	import { serverStore } from "$lib/features/servers/stores/serverStore";
	import { friendStore } from "$lib/features/friends/stores/friendStore";
	import { toasts } from "$lib/stores/ToastStore";
	import ServerContextMenu from "$lib/components/context-menus/ServerContextMenu.svelte";
	import type { Server } from "$lib/features/servers/models/Server";
	import { lastVisitedServerId } from "$lib/stores/navigationStore";
	import { get } from "svelte/store";
	import { SvelteSet } from "svelte/reactivity";
	import { Button } from "$lib/components/ui/button";
	import { Avatar, AvatarImage, AvatarFallback } from "$lib/components/ui/avatar";
	import { ScrollArea } from "$lib/components/ui/scroll-area";
	import { Separator } from "$lib/components/ui/separator";
	import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "$lib/components/ui/tooltip";
	import { cn } from "$lib/utils";

	type NavigationFn = (value: string | URL) => void;
	type ProfileClickHandler = (clientX: number, clientY: number) => void;

	let { onProfileClick, onCreateJoinServerClick }: { onProfileClick: ProfileClickHandler; onCreateJoinServerClick: () => void } = $props();
	const MUTED_SERVERS_STORAGE_KEY = "sidebar.mutedServers";
	let mutedServerIds = $state<SvelteSet<string>>(loadMutedServers());

	const gotoUnsafe: NavigationFn = goto as unknown as NavigationFn;

	function loadMutedServers(): SvelteSet<string> {
		if (typeof localStorage === "undefined") return new SvelteSet();
		try {
			const raw = localStorage.getItem(MUTED_SERVERS_STORAGE_KEY);
			if (!raw) return new SvelteSet();
			const parsed = JSON.parse(raw);
			if (Array.isArray(parsed)) {
				return new SvelteSet(parsed.filter((id): id is string => typeof id === "string"));
			}
		} catch (error) {
			console.warn("Failed to load muted servers from storage", error);
		}
		return new SvelteSet();
	}

	function saveMutedServers(ids: SvelteSet<string>) {
		if (typeof localStorage === "undefined") return;
		try {
			localStorage.setItem(MUTED_SERVERS_STORAGE_KEY, JSON.stringify(Array.from(ids)));
		} catch (error) {
			console.warn("Failed to persist muted servers", error);
		}
	}

	function gotoResolved(path: string) {
		gotoUnsafe(path);
	}

	function gotoServerSettings(serverId: string, tab?: string) {
		const params = new URLSearchParams();
		if (tab) params.set("tab", tab);

		const query = params.toString();
		const href = query ? `/channels/${serverId}/settings?${query}` : `/channels/${serverId}/settings`;
		gotoUnsafe(href);
	}

	function buildInviteLink(serverId: string) {
		const path = `/inv/${serverId}`;
		if (typeof window !== "undefined" && window.location?.origin) {
			return `${window.location.origin}${path}`;
		}
		return path;
	}

	async function copyText(value: string, successMessage: string, errorMessage: string) {
		try {
			if (typeof navigator !== "undefined" && navigator.clipboard) {
				await navigator.clipboard.writeText(value);
				toasts.addToast(successMessage, "success");
			} else {
				throw new Error("Clipboard API unavailable");
			}
		} catch (error) {
			console.error(error);
			toasts.addToast(errorMessage, "error");
		}
	}

	function gotoWithTab(pathname: string, tab: string) {
		const params = new URLSearchParams($page.url.search);
		params.set("tab", tab);
		const query = params.toString();
		const href = query ? `${pathname}?${query}` : pathname;
		gotoUnsafe(href);
	}

	function handleServerClick(server: Server) {
		lastVisitedServerId.set(server.id);
		serverStore.setActiveServer(server.id);
		const targetPath = `/channels/${server.id}`;
		if ($page.url.pathname !== targetPath) gotoUnsafe(targetPath);
	}

	async function handleServerAction({ action, server }: { action: string; server: Server }) {
		switch (action) {
			case "mark_as_read":
				toasts.addToast("All channels marked as read (local).", "info");
				break;
			case "mute_unmute_server": {
				const next = new SvelteSet(mutedServerIds);
				if (next.has(server.id)) {
					next.delete(server.id);
					toasts.addToast("Server unmuted (local).", "info");
				} else {
					next.add(server.id);
					toasts.addToast("Server muted (local).", "info");
				}
				mutedServerIds = next;
				saveMutedServers(next);
				break;
			}
			case "notification_settings":
				lastVisitedServerId.set(server.id);
				gotoResolved("/settings/notifications");
				break;
			case "copy_server_id":
				await copyText(server.id, "Server ID copied.", "Failed to copy server ID.");
				break;
			case "view_icon":
				if (server.iconUrl) {
					await copyText(server.iconUrl, "Icon URL copied.", "Failed to copy icon URL.");
				} else {
					toasts.addToast("This server does not have an icon.", "info");
				}
				break;
			case "view_raw":
				await copyText(JSON.stringify(server, null, 2), "Server data copied.", "Failed to copy server data.");
				break;
			case "invite_people": {
				const link = buildInviteLink(server.id);
				await copyText(link, "Invite link copied.", "Failed to copy invite link.");
				break;
			}
			case "server-settings":
				lastVisitedServerId.set(server.id);
				serverStore.setActiveServer(server.id);
				gotoServerSettings(server.id);
				break;
			case "create_channel":
				lastVisitedServerId.set(server.id);
				serverStore.setActiveServer(server.id);
				gotoServerSettings(server.id, "channels");
				toasts.addToast("Opening server settings. Use the Channels tab to create a channel.", "info");
				break;
			case "create_category":
				lastVisitedServerId.set(server.id);
				serverStore.setActiveServer(server.id);
				gotoServerSettings(server.id, "channels");
				toasts.addToast("Manage categories from the Channels tab.", "info");
				break;
			case "create_event":
				toasts.addToast("Server events are not implemented yet.", "info");
				break;
			case "leave_server":
				if (confirm(`Are you sure you want to leave the server "${server.name}"?`)) {
					try {
						await invoke("leave_server", { server_id: server.id });
						serverStore.removeServer(server.id);

						if (get(serverStore).activeServerId === server.id) {
							serverStore.setActiveServer(null);
							lastVisitedServerId.set(null);
							gotoWithTab("/friends", "All");
						}
					} catch (error) {
						console.error("Failed to leave server:", error);
						toasts.addToast("Failed to leave server. Please try again.", "error");
					}
				}
				break;
			case "delete_server":
				if (confirm(`Delete "${server.name}"? This cannot be undone.`)) {
					try {
						await invoke("delete_server", { server_id: server.id });
						const activeServerId = get(serverStore).activeServerId;
						serverStore.removeServer(server.id);

						if (activeServerId === server.id) {
							serverStore.setActiveServer(null);
							lastVisitedServerId.set(null);
							gotoWithTab("/friends", "All");
						}
						toasts.addToast("Server deleted.", "success");
					} catch (error) {
						console.error("Failed to delete server:", error);
						toasts.addToast("Failed to delete server.", "error");
					}
				}
				break;
			default:
				console.debug("Unhandled server action:", action, server.id);
		}
	}
</script>

<aside class="h-full w-16 min-w-[64px] bg-background flex flex-col items-center py-4 gap-4">
	<TooltipProvider>
		<Tooltip>
			<TooltipTrigger>
				<Button
					size="icon"
					variant="secondary"
					aria-label="Home"
					class="rounded-xl"
					onclick={() => {
						serverStore.setActiveServer(null);
						if ($friendStore.friends.length > 0) {
							gotoWithTab("/", "All");
						} else {
							gotoUnsafe("/friends/add");
						}
					}}
				>
					<Home class="size-4" />
				</Button>
			</TooltipTrigger>
			<TooltipContent side="right">Home</TooltipContent>
		</Tooltip>

		<ScrollArea class="grow w-full">
			<nav class="flex flex-col items-center gap-2 px-2">
				{#each $serverStore.servers as server (server.id)}
					<ServerContextMenu
						server={server}
						muted={mutedServerIds.has(server.id)}
						onaction={handleServerAction}
					>
							<Button
							type="button"
							size="icon"
							variant="outline"
							class={cn(
								"size-10 p-0 rounded-full overflow-hidden border-2",
								$serverStore.activeServerId === server.id ? "border-primary" : "border-border",
								mutedServerIds.has(server.id) && "opacity-60 grayscale"
							)}
							onclick={() => handleServerClick(server)}
							aria-label={server.name}
							>
							{#if server.iconUrl}
								<Avatar class="size-10">
									<AvatarImage src={server.iconUrl} alt={`${server.name} icon`} />
									<AvatarFallback class="text-[10px] font-semibold uppercase">
										{server.name.slice(0, 2)}
									</AvatarFallback>
								</Avatar>
							{:else}
								<Avatar class="size-10">
									<AvatarFallback class="text-xs font-semibold uppercase">
										{server.name.slice(0, 2)}
									</AvatarFallback>
								</Avatar>
							{/if}
						</Button>
					</ServerContextMenu>
				{/each}

				<Tooltip>
					<TooltipTrigger>
						<Button
							size="icon"
							variant="ghost"
							aria-label="Create or Join Server"
							class="rounded-xl"
							onclick={onCreateJoinServerClick}
						>
							<Plus class="size-4" />
						</Button>
					</TooltipTrigger>
					<TooltipContent side="right">Create or Join</TooltipContent>
				</Tooltip>
			</nav>
		</ScrollArea>

		<Separator class="w-10" />

		<div class="flex flex-col items-center gap-3">
			<Tooltip>
				<TooltipTrigger>
					<Button
						size="icon"
						variant="ghost"
						class="rounded-xl"
						aria-label="Settings"
						onclick={() => gotoUnsafe("/settings")}
					>
						<Settings class="size-4" />
					</Button>
				</TooltipTrigger>
				<TooltipContent side="right">Settings</TooltipContent>
			</Tooltip>

			<Button
				variant="outline"
				size="icon"
				class="size-10 p-0 rounded-full overflow-hidden"
				aria-label="Open Profile"
				onclick={(e) => onProfileClick(e.clientX, e.clientY)}
			>
				<Avatar class="size-10">
					<AvatarImage src={$userStore.me?.avatar} alt="User Avatar" />
					<AvatarFallback class="text-xs">ME</AvatarFallback>
				</Avatar>
			</Button>
		</div>
	</TooltipProvider>
</aside>
